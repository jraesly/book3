<html>
<head>
    <style>
        .answer {
            min-height: 50px
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">
</head>
<body>

<div class="container">

    <h1>Image Diffusion Analysis</h1>

    <section id="q1" class="question">
        <h4>Q1: How many unique original images?</h4>
        <div class="answer"></div>
    </section>

    <section id="q2" class="question">
        <h4>Q2: How many unique original tweet users?</h4>
        <div class="answer"></div>
    </section>

    <section id="q3" class="question">
        <h4>Q3: How many times did image (592674938273865700) get retweeted?</h4>
        <div class="answer"></div>
    </section>

    <section id="q4" class="question">
        <h4>Q4: Which image has the most number of retweets?</h4>
        <div class="answer"></div>
    </section>

    <section id="q5" class="question">
        <h4>Q5: How many original tweets were there on 4/26/15?</h4>
        <div class="answer"></div>
    </section>

    <section id="q6" class="question">
        <h4>Q6: Among these original tweets on 4/26/15, what is the most number of times one was retweeted?</h4>
        <div class="answer"></div>
    </section>

    <section id="q7" class="question">
        <h4>Q7: Among these original tweets on 4/26/15, what is the average number of times one was retweeted?</h4>
        <div class="answer"></div>
    </section>

    <section id="q8" class="question">
        <h4>Q8: *FIXME:* Among these original tweets on 4/26/15, how many of them got retweeted within one hour?</h4>
        <div class="answer"></div>
    </section>

    <section id="q9" class="question">
        <h4>Q9: Among these original tweets on 4/26/15, what are the ten most retweeted?</h4>
        <div class="answer"></div>
    </section>

    <section id="q10" class="question">
        <h4>Q10: Among these ten most retweeted, how many of them contain images of people?</h4>
        <div class="answer"></div>
    </section>

</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>

    <script src="http://bigdatahci2015.github.io/data/js/moment.min.js"></script>
    <script>

var items   // global scope (i.e., can be accessed in javascript console)

function solution1() {
    return _.unique(_.pluck(items, 'Image Id Str')).length
}

function solution2() {
    return _.unique(_.pluck(items, 'Original User Name')).length
}

function solution3() {
    return _.filter(items, function(d) {
        return (d['Image Id Str'] == '592674938273865700' && d.Rt == 'Retweet')
    }).length
}

function solution4() {
    var groups = _.groupBy(items, 'Image Id Str')
    var counts = _.mapValues(groups, function(d) {
        return d.length
    })
    // Here I use _sortBy() to find image with most (max) retweets
    var pairs = _.pairs(counts)
    var sorted_pairs = _.sortBy(pairs, function(d) {
        return -d[1]
    })
    return sorted_pairs[0][0]
}

function solution5() {
    // Get the '* Original Tweet Created At' == '' (NULL)
    var origTweets = _.filter(items, function(d) {
        return d['* Original Tweet Created At'] == ''
    })

    // Daily stats
    var orig25 = _.filter(origTweets, function(d) {
        return _.first(d['* Tweet Created At'].split(' ')) == '4/25/15'
    }).length
    console.log('4/25/15 Orinial Tweets:', orig25)
    var orig26 = _.filter(origTweets, function(d) {
        return _.first(d['* Tweet Created At'].split(' ')) == '4/26/15'
    }).length
    console.log('4/26/15 Orinial Tweets:', orig26)
    var orig27 = _.filter(origTweets, function(d) {
        return _.first(d['* Tweet Created At'].split(' ')) == '4/27/15'
    }).length
    console.log('4/27/15 Orinial Tweets:', orig27)
    var orig28 = _.filter(origTweets, function(d) {
        return _.first(d['* Tweet Created At'].split(' ')) == '4/28/15'
    }).length
    console.log('4/28/15 Orinial Tweets:', orig28)
    var orig29 = _.filter(origTweets, function(d) {
        return _.first(d['* Tweet Created At'].split(' ')) == '4/29/15'
    }).length
    console.log('4/29/15 Orinial Tweets:', orig29)
    var orig30 = _.filter(origTweets, function(d) {
        return _.first(d['* Tweet Created At'].split(' ')) == '4/30/15'
    }).length
    console.log('4/30/15 Orinial Tweets:', orig30)

    retweet25 = _.filter(items, function(d) {
        return (d.Rt == 'Retweet' && _.first(d['* Tweet Created At'].split(' ')) == '4/25/15')
    }).length
    console.log('4/25/15 Retweets:', retweet25)
    retweet26 = _.filter(items, function(d) {
        return (d.Rt == 'Retweet' && _.first(d['* Tweet Created At'].split(' ')) == '4/26/15')
    }).length
    console.log('4/26/15 Retweets:', retweet26)
    retweet27 = _.filter(items, function(d) {
        return (d.Rt == 'Retweet' && _.first(d['* Tweet Created At'].split(' ')) == '4/27/15')
    }).length
    console.log('4/27/15 Retweets:', retweet27)
    retweet28 = _.filter(items, function(d) {
        return (d.Rt == 'Retweet' && _.first(d['* Tweet Created At'].split(' ')) == '4/28/15')
    }).length
    console.log('4/28/15 Retweets:', retweet28)
    retweet29 = _.filter(items, function(d) {
        return (d.Rt == 'Retweet' && _.first(d['* Tweet Created At'].split(' ')) == '4/29/15')
    }).length
    console.log('4/29/15 Retweets:', retweet29)
    retweet30 = _.filter(items, function(d) {
        return (d.Rt == 'Retweet' && _.first(d['* Tweet Created At'].split(' ')) == '4/30/15')
    }).length
    console.log('4/30/15 Retweets:', retweet30)

    day25Tweets = orig25 + retweet25
    day26Tweets = orig26 + retweet26
    day27Tweets = orig27 + retweet27
    day28Tweets = orig28 + retweet28
    day29Tweets = orig29 + retweet29
    day30Tweets = orig30 + retweet30
    console.log('day25Tweets:', day25Tweets)
    console.log('day26Tweets:', day26Tweets)
    console.log('day27Tweets:', day27Tweets)
    console.log('day28Tweets:', day28Tweets)
    console.log('day29Tweets:', day29Tweets)
    console.log('day30Tweets:', day30Tweets)
    AllTweets = day25Tweets + day26Tweets + day27Tweets + day28Tweets + day29Tweets + day30Tweets
    console.log('AllTweets', AllTweets)

    return _.filter(origTweets, function(d) {
        return _.first(d['* Tweet Created At'].split(' ')) == '4/26/15'
    }).length
}

function solution6() {
    var dateTweets = _.filter(items, function(d) {
        return _.includes(d['* Original Tweet Created At'], '4/26/15')
    })

    var groups = _.groupBy(dateTweets, 'Image Id Str')
    var counts = _.mapValues(groups, function(d) {
        return d.length
    })

    var pairs = _.pairs(counts)
    var sorted_pairs = _.sortBy(pairs, function(d) {
        return -d[1]
    })
    return sorted_pairs[0][1]
}

function solution7() {
    var dateTweets = _.filter(items, function(d) {
        return _.includes(d['* Original Tweet Created At'], '4/26/15')
    })
    var groups = _.groupBy(dateTweets, 'Image Id Str')
    var counts = _.mapValues(groups, function(d) {
        return d.length
    })
    var pairs = _.pairs(counts)
    var entries = _.size(pairs)
    var sum = _.sum(pairs, function(d) { return d[1] })
    var average = sum/entries

    return _.round(average, 2)
}

function solution8() {
    // http://momentjs.com/docs/#/durations/add/
    // http://momentjs.com/docs/#/query/is-before/
    var dateTweets = _.filter(items, function(d) {
        return _.first(d['* Original Tweet Created At'].split(' ')) == '4/26/15'
    })

    var groups = _.groupBy(dateTweets, 'Image Id Str')
    console.log('groups.length', _.size(groups))

    var image_info = _.map(dateTweets, function(d) {
        return { 'imageID': d['Image Id Str'],
                 'originalDate': moment(d['* Original Tweet Created At']),
                 'createDate': moment(d['* Tweet Created At']) }
    })
    console.log('image_info', image_info)
    console.log('image_info.length', image_info.length)

    return findHourRetweets = _.filter(image_info, function(d) {
        var deltaTimeStamp = d.originalDate.add(1, 'hours')
        return moment(deltaTimeStamp).isBefore(d.createDate) == false
    }).length

}

function solution9() {

    var dateTweets = _.filter(items, function(d) {
        return _.includes(d['* Original Tweet Created At'], '4/26/15')
    })

    var groups = _.groupBy(dateTweets, 'Image Id Str')
    var counts = _.mapValues(groups, function(d) {
        return d.length
    })

    var pairs = _.pairs(counts)
    var sorted_pairs = _.sortBy(pairs, function(d) {
        return -d[1]
    })
    var top10 = _.take(sorted_pairs, 10)

    return top10.join('; ')
}

function solution10() {
    return '3 of the most retweeted images on 4/26/15 contained images of people; Image ID 592139111860940800 has some nice golder retrievers in the palace guard; FYI I could not get the most popular retweeted image to load!'
}

function run(id, solutionFunc, data){
    console.log('run solution for ' + id)
    var answer = solutionFunc(data)
    $(id).find('.answer').html(answer)
}

function loadDataThenRunSolutions(){
    $.get({url: './nepal_local_tweets.json'})
     .done(function(data){
        //  var lines = data.trim().split('\n')
        items = data
         // convert text lines to json arrays and save them in `items`
        //  items = _.map(lines, JSON.parse)

         console.log('number of items loaded:', items.length)
         console.log('first item', items[0])

         run('#q1', solution1, items)
         run('#q2', solution2, items)
         run('#q3', solution3, items)
         run('#q4', solution4, items)
         run('#q5', solution5, items)
         run('#q6', solution6, items)
         run('#q7', solution7, items)
         run('#q8', solution8, items)
         run('#q9', solution9, items)
         run('#q10', solution10, items)
     })
     .fail(function(err){
         console.error(err)
     })
}

loadDataThenRunSolutions()

    </script>

</body>
</html>
